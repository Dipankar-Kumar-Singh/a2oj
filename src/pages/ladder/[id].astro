---
import Layout from '../../layouts/Layout.astro';
import type { LadderData, DisplayProblem, AnalyticsRange, LadderType } from '../../types';
import {
	laddersIndex,
	getLadderOverride,
	getRatingLevelsSorted,
	getRatingLevel,
	processProblems,
	getAllTags,
	getRatingRange,
	formatLadderNumber,
	calculateAnalyticsRanges,
	getProblemUrl,
} from '../../utils/ladders';

// Import all ladder JSON files
const ladderModules = import.meta.glob<{ default: LadderData }>('../../data/ladders/ladder-*.json', { eager: true });

export function getStaticPaths() {
	const ids = [
		...laddersIndex.rating.map((l) => l.id),
		...laddersIndex.division.map((l) => l.id),
		...laddersIndex.extra.map((l) => l.id),
	];
	return ids.map((id) => ({ params: { id: String(id) } }));
}

const { id } = Astro.params;
const ladderId = parseInt(id!, 10);

// Find the ladder data from imported modules
const ladderKey = Object.keys(ladderModules).find((key) => key.includes(`ladder-${id}.json`));
const ladderData: LadderData | null = ladderKey ? ladderModules[ladderKey].default : null;

if (!ladderData) {
	return Astro.redirect('/404');
}

const override = getLadderOverride(ladderId);
const ladderDifficultyLevel = ladderData.difficultyLevel || 1;
const ratingLevel = getRatingLevel(ladderDifficultyLevel);
const ladderType = ladderData.type as LadderType;

const ladder = {
	id: ladderData.id,
	name: override?.displayName ?? ladderData.name,
	description: ladderData.description ?? '',
	difficulty: ladderDifficultyLevel,
	difficultyLabel: override?.difficultyLabel ?? ratingLevel.name,
	type: ladderType,
	division: override?.division ?? null,
	problemType: override?.problemType ?? null,
	isExtra: override?.isExtra ?? false,
};

const problems: readonly DisplayProblem[] = processProblems(ladderData);
const allTags = getAllTags(problems);
const { min: minRating, max: maxRating } = getRatingRange(problems);
const solvedCount = 0;
const progressPercent = 0;
const analyticsRanges: readonly AnalyticsRange[] = calculateAnalyticsRanges(problems);
const ladderNumber = formatLadderNumber(ladderId, ladderType);
const pageData = { ladderId };
---

<Layout title={`${ladder.name} | A2OJ Refreshed`}>
	<main class="min-h-screen bg-slate-50 dark:bg-slate-950 full-page-grid">
		<!-- Engineering-Style Header -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-6">
			<!-- Back Link + Controls Row -->
			<div class="flex items-center justify-between mb-8">
				<a href="/" class="inline-flex items-center engineering-back-link">
					<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
					</svg>
					<span>BACK TO LADDERS</span>
				</a>
				
				<!-- Settings Controls -->
				<div class="flex items-center gap-2">
					<button id="zen-mode-btn" class="engineering-icon-btn with-label" title="Zen Mode - Hide all filters">
						<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
							<circle cx="12" cy="12" r="9" />
							<circle cx="12" cy="12" r="3" />
						</svg>
						<span class="btn-label">ZEN</span>
					</button>
					<button id="theme-toggle" class="engineering-icon-btn" title="Toggle Dark Mode">
						<svg class="w-4 h-4 sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
							<circle cx="12" cy="12" r="4" />
							<path d="M12 2v2m0 16v2m10-10h-2M4 12H2m15.364 6.364l-1.414-1.414M7.05 7.05L5.636 5.636m12.728 0l-1.414 1.414M7.05 16.95l-1.414 1.414" />
						</svg>
						<svg class="w-4 h-4 moon-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
							<path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
						</svg>
					</button>
				</div>
			</div>
			
			<!-- Main Header Box -->
			<div class={`engineering-header-card ${ladder.isExtra ? 'engineering-header-purple' : ladder.type === 'division' ? 'engineering-header-amber' : ''}`}>
				<div class="engineering-card-corner engineering-card-corner-tl"></div>
				<div class="engineering-card-corner engineering-card-corner-tr"></div>
				<div class="engineering-card-corner engineering-card-corner-bl"></div>
				<div class="engineering-card-corner engineering-card-corner-br"></div>
				
				<div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
					<div class="flex-1">
						<span class="engineering-card-label">
							{ladder.type === 'rating' ? `LADDER ${ladderNumber}` : 
							 ladder.type === 'division' ? ladderNumber :
							 `EXTRA ${ladderNumber}`}
						</span>
						<h1 class="engineering-page-title">{ladder.name}</h1>
						<p class="engineering-page-subtitle">{ladder.description}</p>
					</div>
					
					<div class="flex items-center gap-4">
						{ladder.type !== 'division' && (
							<div class="engineering-stat-box">
								<span class="engineering-stat-label">LEVEL</span>
								<span class={`engineering-stat-value ${ladder.isExtra ? 'text-purple-600 dark:text-purple-400' : 'text-teal-600 dark:text-teal-400'}`}>
									{ladder.difficultyLabel}
								</span>
							</div>
						)}
						{ladder.type === 'division' && ladder.problemType && (
							<div class="engineering-stat-box">
								<span class="engineering-stat-label">PROBLEM TYPE</span>
								<span class="engineering-stat-value text-amber-600 dark:text-amber-400">{ladder.problemType}</span>
							</div>
						)}
						<div class="engineering-stat-box">
							<span class="engineering-stat-label">PROBLEMS</span>
							<span class={`engineering-stat-value ${ladder.isExtra ? 'text-purple-600 dark:text-purple-400' : ladder.type === 'division' ? 'text-amber-600 dark:text-amber-400' : 'text-teal-600 dark:text-teal-400'}`}>
								{problems.length}
							</span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Progress Section -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
			<div class="section-header mb-6">
				<div class="section-header-line"></div>
				<div class="section-header-box">
					<span class="section-header-label">PROGRESS</span>
					<h2 class="section-header-title text-lg">Your Statistics</h2>
				</div>
				<div class="section-header-line flex-1"></div>
				<div class="section-header-corner"></div>
			</div>
			
			<div class="engineering-card">
				<div class="engineering-card-corner engineering-card-corner-tl"></div>
				<div class="engineering-card-corner engineering-card-corner-tr"></div>
				<div class="engineering-card-corner engineering-card-corner-bl"></div>
				<div class="engineering-card-corner engineering-card-corner-br"></div>
				
				<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
					<div class="flex-1">
						<div class="flex items-center justify-between mb-3">
							<span class="engineering-card-label">SOLVED</span>
						</div>
						<div class="engineering-progress-bar">
							<div 
								class="engineering-progress-fill"
								style={`width: ${progressPercent}%`}
							></div>
						</div>
					</div>
					<div class="engineering-stat-box engineering-stat-box-accent">
						<span class="engineering-stat-label">COMPLETION</span>
						<span class="engineering-progress-count text-teal-600 dark:text-teal-400">{solvedCount}<span class="text-slate-400 dark:text-slate-500"> / {problems.length}</span></span>
					</div>
				</div>
			</div>
		</div>

		<!-- Problems Table -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
			<div class="section-header mb-6">
				<div class="section-header-line"></div>
				<div class="section-header-box">
					<span class="section-header-label">PROBLEM SET</span>
					<h2 class="section-header-title text-lg">All Problems</h2>
				</div>
				<div class="section-header-line flex-1"></div>
				
				<!-- Filter Controls -->
				<div class="filter-toggle-container">
					<!-- Hide Solved Toggle -->
					<button id="hide-solved-toggle" class="filter-toggle-btn" title="Hide solved problems">
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
						</svg>
						<span class="filter-toggle-text">Hide Solved</span>
					</button>
					<span id="filter-count" class="filter-count hidden"></span>
				</div>
				
				<div class="section-header-corner"></div>
			</div>
			
		<div id="filter-panel" class="engineering-filter-panel mb-4 filter-panel-animated">
				<div class="engineering-card-corner engineering-card-corner-tl"></div>
				<div class="engineering-card-corner engineering-card-corner-br"></div>
				
				<div class="flex flex-wrap items-center gap-4">
					<!-- Column Visibility Toggles -->
					<div class="filter-group">
						<span class="filter-group-label">SHOW/HIDE</span>
						<div class="flex gap-2">
							<button id="toggle-difficulty" class="column-toggle-btn active" data-column="difficulty" title="Toggle Difficulty column">
								<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
								</svg>
								Difficulty
							</button>
							<button id="toggle-rating" class="column-toggle-btn active" data-column="rating" title="Toggle Rating column">
								<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
								</svg>
								Rating
							</button>
							<button id="toggle-tags" class="column-toggle-btn active" data-column="tags" title="Toggle Tags column">
								<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
								</svg>
								Tags
							</button>
							<button id="toggle-problemid" class="column-toggle-btn active" data-column="problemId" title="Toggle Problem ID (CF-XXX/X)">
								<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
								</svg>
								Problem ID
							</button>
						</div>
					</div>
					
					<!-- Rating Filter -->
					<div class="filter-group">
						<span class="filter-group-label">RATING RANGE</span>
						<div class="flex items-center gap-2">
							<input type="number" id="rating-min" class="rating-input" placeholder="0" min="0" max="4000" step="100" />
							<span class="text-slate-400">—</span>
							<input type="number" id="rating-max" class="rating-input rating-input-infinity" placeholder="∞" min="0" max="99999" step="100" />
						</div>
					</div>
					
					<!-- Rating Sort -->
					<div class="filter-group">
						<span class="filter-group-label">SORT BY RATING</span>
						<div class="flex gap-1">
							<button id="sort-rating-asc" class="sort-btn" title="Sort by rating ascending">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
								</svg>
							</button>
							<button id="sort-rating-desc" class="sort-btn" title="Sort by rating descending">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4" />
								</svg>
							</button>
							<button id="sort-reset" class="sort-btn" title="Reset to original order">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
								</svg>
							</button>
						</div>
				</div>
				
				<div id="tag-filter-group" class="filter-group tag-filter-container">
						<span class="filter-group-label">FILTER BY TAG</span>
						<div class="tag-multi-select">
							<button id="tag-filter-toggle" class="tag-filter-trigger" type="button">
								<span class="tag-filter-text">All Tags</span>
								<svg class="w-3 h-3 ml-1 chevron-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
								</svg>
							</button>
							<div id="tag-filter-dropdown" class="tag-filter-dropdown hidden">
								<div class="tag-match-mode">
									<button type="button" class="tag-match-btn active" data-mode="all">All of</button>
									<button type="button" class="tag-match-btn" data-mode="any">Any of</button>
								</div>
								<div class="tag-options-list">
									{allTags.map((tag) => (
										<label class="tag-option">
											<input type="checkbox" value={tag} class="tag-checkbox" />
											<span class="tag-option-text">{tag}</span>
										</label>
									))}
								</div>
							</div>
						</div>
					</div>
					
					<button id="clear-filters" class="clear-filters-btn">
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
						</svg>
						Clear
					</button>
				</div>
			</div>
			
			<div class="engineering-table-container">
				<div class="engineering-card-corner engineering-card-corner-tl"></div>
				<div class="engineering-card-corner engineering-card-corner-tr"></div>
				<div class="engineering-card-corner engineering-card-corner-bl"></div>
				<div class="engineering-card-corner engineering-card-corner-br"></div>
				
				<div class="overflow-x-auto">
					<table class="w-full" id="problems-table">
						<thead>
							<tr class="engineering-table-header">
								<th class="px-6 py-4 text-left w-16">
									<span class="engineering-table-th">#</span>
								</th>
								<th class="px-6 py-4 text-left">
									<span class="engineering-table-th">PROBLEM</span>
								</th>
								<th class="rating-header px-6 py-4 text-left w-24">
									<span class="engineering-table-th">RATING</span>
								</th>
								<th class="difficulty-header px-6 py-4 text-left w-28">
									<span class="engineering-table-th">DIFFICULTY</span>
								</th>
								<th class="tags-header px-6 py-4 text-left">
									<span class="engineering-table-th">TAGS</span>
								</th>
								<th class="px-6 py-4 text-center w-24">
									<span class="engineering-table-th">STATUS</span>
								</th>
							</tr>
						</thead>
						<tbody class="engineering-table-body">
							{problems.map((problem) => (
								<tr 
									class="engineering-table-row"
									data-problem-id={`${problem.contestId}${problem.problemId}`}
									data-position={problem.id}
									data-rating={problem.rating || 0}
									data-tags={problem.tags.join(',')}
								>
									<td class="px-6 py-4">
										<span class="engineering-table-index">{String(problem.id).padStart(2, '0')}</span>
									</td>
									<td class="px-6 py-4">
										<a 
											href={`https://codeforces.com/problemset/problem/${problem.contestId}/${problem.problemId}`}
											target="_blank"
											rel="noopener noreferrer"
											class="engineering-table-link group"
										>
											{problem.name}
											<svg class="w-3 h-3 ml-2 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
											</svg>
										</a>
										<div class="engineering-table-meta">
											CF-{problem.contestId}/{problem.problemId}
										</div>
									</td>
									<td class="rating-cell px-6 py-4">
										{problem.rating ? (
											<span class={`engineering-rating ${problem.rating < 1200 ? 'rating-newbie' : problem.rating < 1400 ? 'rating-pupil' : problem.rating < 1600 ? 'rating-specialist' : problem.rating < 1900 ? 'rating-expert' : problem.rating < 2100 ? 'rating-cm' : problem.rating < 2300 ? 'rating-master' : 'rating-gm'}`}>
												{problem.rating}
											</span>
										) : (
											<span class="engineering-rating rating-unrated">—</span>
										)}
									</td>
									<td class="difficulty-cell px-6 py-4">
										<div class="engineering-difficulty">
										<span class="engineering-difficulty-bar" style={`--bar-width: ${problem.difficulty * 20}%`}></span>
											<span class="engineering-difficulty-text">LVL {problem.difficulty}</span>
										</div>
									</td>
									<td class="tags-cell px-6 py-4">
										<div class="flex flex-wrap gap-1">
											{problem.tags.slice(0, 3).map((tag) => (
												<span class="engineering-tag">{tag}</span>
											))}
											{problem.tags.length > 3 && (
												<span class="engineering-tag engineering-tag-more">+{problem.tags.length - 3}</span>
											)}
										</div>
									</td>
									<td class="px-6 py-4 text-center status-cell">
										<div class="engineering-status engineering-status-pending">
											<span class="w-2 h-2 bg-current rounded-full"></span>
										</div>
									</td>
								</tr>
							))}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Quick Stats -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
			<div class="section-header mb-6">
				<div class="section-header-line"></div>
				<div class="section-header-box">
					<span class="section-header-label">ANALYTICS</span>
					<h2 class="section-header-title text-lg">Quick Stats</h2>
				</div>
				<div class="section-header-line flex-1"></div>
				<div class="section-header-corner"></div>
			</div>
			
			{/* Tailwind safelist: text-gray-500 dark:text-gray-400 text-green-600 dark:text-green-400 text-cyan-600 dark:text-cyan-400 text-blue-600 dark:text-blue-400 text-violet-600 dark:text-violet-400 text-orange-500 dark:text-orange-400 text-orange-600 text-red-600 dark:text-red-400 text-red-500 text-red-700 dark:text-red-300 */}
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
				{analyticsRanges.map((range) => (
					<div class="engineering-stat-card">
						<div class="engineering-card-corner engineering-card-corner-tl"></div>
						<div class="engineering-card-corner engineering-card-corner-br"></div>
						<span class="engineering-card-label">{range.label.toUpperCase()}</span>
						<div class={`engineering-stat-card-value ${range.textClass}`}>
							{range.count}
						</div>
						<span class="engineering-card-unit">PROBLEMS</span>
					</div>
				))}
			</div>
		</div>
	</main>
</Layout>

<!-- Page Data for Client-Side Script -->
<script type="application/json" id="page-data" set:html={JSON.stringify(pageData)}></script>

<!-- Client-Side Script (TypeScript compiled) -->
<script>
	import '../../scripts/ladder-page';
</script>

