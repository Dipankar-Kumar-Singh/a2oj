---
import Layout from '../../layouts/Layout.astro';
import Settings from '../../components/Settings.astro';
import laddersIndex from '../../data/ladders/index.json';
import laddersMetadata from '../../data/ladders/metadata.json';

// Type definitions
interface LadderOverride {
	displayName?: string;
	difficultyLabel?: string;
	division?: string;
	problemType?: string;
	isExtra?: boolean;
}

interface Problem {
	id: number;
	name: string;
	contestId: number;
	problemId: string;
	difficulty: number;
	tags: string[];
}

interface LadderData {
	id: number;
	name: string;
	type: string;
	description: string;
	difficultyLevel: number;
	problemCount: number;
	problems: Array<{
		position: number;
		name: string;
		contestId: number;
		problemId: string;
		difficulty?: number;
		tags?: string[];
	}>;
}

// Import all ladder JSON files
const ladderModules = import.meta.glob<{ default: LadderData }>('../../data/ladders/ladder-*.json', { eager: true });

export function getStaticPaths() {
	const ids = [
		...laddersIndex.rating.map(l => l.id),
		...laddersIndex.division.map(l => l.id),
		...laddersIndex.extra.map(l => l.id)
	];
	return ids.map(id => ({ params: { id: String(id) } }));
}

const { id } = Astro.params;
const ladderId = parseInt(id as string);

// Find the ladder data from imported modules
const ladderKey = Object.keys(ladderModules).find(key => key.includes(`ladder-${id}.json`));
const ladderData: LadderData | null = ladderKey ? ladderModules[ladderKey].default : null;

if (!ladderData) {
	return Astro.redirect('/404');
}

// Get metadata for display
const overrides = laddersMetadata.ladderOverrides as Record<string, LadderOverride>;
const difficultyLabelsMap = laddersMetadata.difficultyLabels as Record<string, string>;
const meta: LadderOverride = overrides[id as string] || {};

// Build ladder object with display metadata
const ladder = {
	id: ladderData.id,
	name: meta.displayName || ladderData.name,
	description: ladderData.description || '',
	difficulty: ladderData.difficultyLevel || 1,
	difficultyLabel: meta.difficultyLabel || difficultyLabelsMap[String(ladderData.difficultyLevel)] || 'Unknown',
	type: ladderData.type,
	division: meta.division || null,
	problemType: meta.problemType || null,
	isExtra: meta.isExtra || false
};

// Map problems from scraped data
const problems: Problem[] = ladderData.problems.map((p) => ({
	id: p.position,
	name: p.name,
	contestId: p.contestId,
	problemId: p.problemId,
	difficulty: p.difficulty || 1,
	tags: p.tags || []
}));

// Calculate initial progress (will be updated client-side)
const solvedCount = 0;
const progressPercent = 0;

const difficultyColors: Record<number, string> = {
	1: 'text-teal-600 dark:text-teal-400',
	2: 'text-cyan-600 dark:text-cyan-400',
	3: 'text-amber-600 dark:text-amber-400',
	4: 'text-orange-600 dark:text-orange-400',
	5: 'text-rose-600 dark:text-rose-400',
};

// Get ladder number for display
function getLadderNumber(ladderId: number, type: string): string {
	if (type === 'rating') {
		const index = laddersIndex.rating.findIndex(l => l.id === ladderId);
		return index >= 0 ? String(index + 1).padStart(2, '0') : String(ladderId);
	} else if (type === 'division') {
		return meta.division ? `${meta.division.toUpperCase().replace('DIVISION ', 'DIV.')}` : String(ladderId);
	} else if (type === 'extra') {
		const index = laddersIndex.extra.findIndex(l => l.id === ladderId);
		return `EX-${index >= 0 ? String(index + 1).padStart(2, '0') : ladderId}`;
	}
	return String(ladderId);
}

const ladderNumber = getLadderNumber(ladderId, ladder.type);
---

<Layout title={`${ladder.name} | A2OJ Refreshed`}>
	<main class="min-h-screen bg-slate-50 dark:bg-slate-950 full-page-grid">
		<!-- Engineering-Style Header -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-6">
			<!-- Back Link -->
			<a href="/" class="inline-flex items-center engineering-back-link mb-8">
				<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				<span>BACK TO LADDERS</span>
			</a>
			
			<!-- Main Header Box -->
			<div class={`engineering-header-card ${ladder.isExtra ? 'engineering-header-purple' : ladder.type === 'division' ? 'engineering-header-amber' : ''}`}>
				<div class="engineering-card-corner engineering-card-corner-tl"></div>
				<div class="engineering-card-corner engineering-card-corner-tr"></div>
				<div class="engineering-card-corner engineering-card-corner-bl"></div>
				<div class="engineering-card-corner engineering-card-corner-br"></div>
				
				<div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
					<div class="flex-1">
						<span class="engineering-card-label">
							{ladder.type === 'rating' ? `LADDER ${ladderNumber}` : 
							 ladder.type === 'division' ? ladderNumber :
							 `EXTRA ${ladderNumber}`}
						</span>
						<h1 class="engineering-page-title">{ladder.name}</h1>
						<p class="engineering-page-subtitle">{ladder.description}</p>
					</div>
					
					<div class="flex items-center gap-4">
						{ladder.type !== 'division' && (
							<div class="engineering-stat-box">
								<span class="engineering-stat-label">LEVEL</span>
								<span class={`engineering-stat-value ${ladder.isExtra ? 'text-purple-600 dark:text-purple-400' : 'text-teal-600 dark:text-teal-400'}`}>
									{ladder.difficultyLabel}
								</span>
							</div>
						)}
						{ladder.type === 'division' && ladder.problemType && (
							<div class="engineering-stat-box">
								<span class="engineering-stat-label">PROBLEM TYPE</span>
								<span class="engineering-stat-value text-amber-600 dark:text-amber-400">{ladder.problemType}</span>
							</div>
						)}
						<div class="engineering-stat-box">
							<span class="engineering-stat-label">PROBLEMS</span>
							<span class={`engineering-stat-value ${ladder.isExtra ? 'text-purple-600 dark:text-purple-400' : ladder.type === 'division' ? 'text-amber-600 dark:text-amber-400' : 'text-teal-600 dark:text-teal-400'}`}>
								{problems.length}
							</span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Progress Section -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
			<div class="section-header mb-6">
				<div class="section-header-line"></div>
				<div class="section-header-box">
					<span class="section-header-label">PROGRESS</span>
					<h2 class="section-header-title text-lg">Your Statistics</h2>
				</div>
				<div class="section-header-line flex-1"></div>
				<div class="section-header-corner"></div>
			</div>
			
			<div class="engineering-card">
				<div class="engineering-card-corner engineering-card-corner-tl"></div>
				<div class="engineering-card-corner engineering-card-corner-tr"></div>
				<div class="engineering-card-corner engineering-card-corner-bl"></div>
				<div class="engineering-card-corner engineering-card-corner-br"></div>
				
				<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
					<div class="flex-1">
						<div class="flex items-center justify-between mb-3">
							<span class="engineering-card-label">SOLVED</span>
							<span class="engineering-progress-count">{solvedCount}<span class="text-slate-400 dark:text-slate-500"> / {problems.length}</span></span>
						</div>
						<div class="engineering-progress-bar">
							<div 
								class="engineering-progress-fill"
								style={`width: ${progressPercent}%`}
							></div>
						</div>
					</div>
					<div class="engineering-stat-box engineering-stat-box-accent">
						<span class="engineering-stat-label">COMPLETION</span>
						<span class="engineering-stat-value-lg text-teal-600 dark:text-teal-400">{progressPercent}%</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Problems Table -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
			<div class="section-header mb-6">
				<div class="section-header-line"></div>
				<div class="section-header-box">
					<span class="section-header-label">PROBLEM SET</span>
					<h2 class="section-header-title text-lg">All Problems</h2>
				</div>
				<div class="section-header-line flex-1"></div>
				<div class="section-header-corner"></div>
			</div>
			
			<div class="engineering-table-container">
				<div class="engineering-card-corner engineering-card-corner-tl"></div>
				<div class="engineering-card-corner engineering-card-corner-tr"></div>
				<div class="engineering-card-corner engineering-card-corner-bl"></div>
				<div class="engineering-card-corner engineering-card-corner-br"></div>
				
				<div class="overflow-x-auto">
					<table class="w-full">
						<thead>
							<tr class="engineering-table-header">
								<th class="px-6 py-4 text-left w-16">
									<span class="engineering-table-th">#</span>
								</th>
								<th class="px-6 py-4 text-left">
									<span class="engineering-table-th">PROBLEM</span>
								</th>
								<th class="difficulty-header px-6 py-4 text-left w-28">
									<span class="engineering-table-th">DIFFICULTY</span>
								</th>
								<th class="tags-header px-6 py-4 text-left">
									<span class="engineering-table-th">TAGS</span>
								</th>
								<th class="px-6 py-4 text-center w-24">
									<span class="engineering-table-th">STATUS</span>
								</th>
							</tr>
						</thead>
						<tbody class="engineering-table-body">
							{problems.map((problem) => (
								<tr 
									class="engineering-table-row"
									data-problem-id={`${problem.contestId}${problem.problemId}`}
								>
									<td class="px-6 py-4">
										<span class="engineering-table-index">{String(problem.id).padStart(2, '0')}</span>
									</td>
									<td class="px-6 py-4">
										<a 
											href={`https://codeforces.com/problemset/problem/${problem.contestId}/${problem.problemId}`}
											target="_blank"
											rel="noopener noreferrer"
											class="engineering-table-link group"
										>
											{problem.name}
											<svg class="w-3 h-3 ml-2 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
											</svg>
										</a>
										<div class="engineering-table-meta">
											CF-{problem.contestId}/{problem.problemId}
										</div>
									</td>
									<td class="difficulty-cell px-6 py-4">
										<div class="engineering-difficulty">
											<span class="engineering-difficulty-bar" style={`width: ${problem.difficulty * 20}%`}></span>
											<span class="engineering-difficulty-text">LVL {problem.difficulty}</span>
										</div>
									</td>
									<td class="tags-cell px-6 py-4">
										<div class="flex flex-wrap gap-1">
											{problem.tags.slice(0, 3).map((tag) => (
												<span class="engineering-tag">{tag}</span>
											))}
											{problem.tags.length > 3 && (
												<span class="engineering-tag engineering-tag-more">+{problem.tags.length - 3}</span>
											)}
										</div>
									</td>
									<td class="px-6 py-4 text-center status-cell">
										<div class="engineering-status engineering-status-pending">
											<span class="w-2 h-2 bg-current rounded-full"></span>
										</div>
									</td>
								</tr>
							))}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Quick Stats -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
			<div class="section-header mb-6">
				<div class="section-header-line"></div>
				<div class="section-header-box">
					<span class="section-header-label">ANALYTICS</span>
					<h2 class="section-header-title text-lg">Quick Stats</h2>
				</div>
				<div class="section-header-line flex-1"></div>
				<div class="section-header-corner"></div>
			</div>
			
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
				<div class="engineering-stat-card">
					<div class="engineering-card-corner engineering-card-corner-tl"></div>
					<div class="engineering-card-corner engineering-card-corner-br"></div>
					<span class="engineering-card-label">EASY</span>
					<div class="engineering-stat-card-value text-teal-600 dark:text-teal-400">
						{problems.filter(p => p.difficulty === 1).length}
					</div>
					<span class="engineering-card-unit">PROBLEMS</span>
				</div>
				<div class="engineering-stat-card">
					<div class="engineering-card-corner engineering-card-corner-tl"></div>
					<div class="engineering-card-corner engineering-card-corner-br"></div>
					<span class="engineering-card-label">MEDIUM</span>
					<div class="engineering-stat-card-value text-cyan-600 dark:text-cyan-400">
						{problems.filter(p => p.difficulty === 2).length}
					</div>
					<span class="engineering-card-unit">PROBLEMS</span>
				</div>
				<div class="engineering-stat-card">
					<div class="engineering-card-corner engineering-card-corner-tl"></div>
					<div class="engineering-card-corner engineering-card-corner-br"></div>
					<span class="engineering-card-label">HARD</span>
					<div class="engineering-stat-card-value text-amber-600 dark:text-amber-400">
						{problems.filter(p => p.difficulty === 3).length}
					</div>
					<span class="engineering-card-unit">PROBLEMS</span>
				</div>
				<div class="engineering-stat-card">
					<div class="engineering-card-corner engineering-card-corner-tl"></div>
					<div class="engineering-card-corner engineering-card-corner-br"></div>
					<span class="engineering-card-label">COMPLETE</span>
					<div class="engineering-stat-card-value text-teal-600 dark:text-teal-400">
						{progressPercent}%
					</div>
					<span class="engineering-card-unit">SOLVED</span>
				</div>
			</div>
		</div>
	</main>

	<!-- Settings Component -->
	<Settings />
</Layout>

<script>
	// Load solved problems from localStorage and update UI
	interface SolvedData {
		handle: string;
		solved: string[];
		lastUpdated: string;
	}

	function loadSolvedProblems(): string[] {
		const solvedStr = localStorage.getItem('cf_solved');
		if (!solvedStr) return [];
		try {
			return JSON.parse(solvedStr);
		} catch {
			return [];
		}
	}

	function updateProblemStatus(problemId: string, row: HTMLElement): void {
		const statusCell = row.querySelector('.status-cell');
		if (!statusCell) return;

		// Replace pending indicator with solved checkmark
		statusCell.innerHTML = `
			<div class="engineering-status engineering-status-solved">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
				</svg>
			</div>
		`;
	}

	function updateProgressBar(solvedCount: number, totalCount: number): void {
		const progressPercent = Math.round((solvedCount / totalCount) * 100);
		
		// Update progress fill
		const progressFill = document.querySelector('.engineering-progress-fill') as HTMLElement;
		if (progressFill) {
			progressFill.style.width = `${progressPercent}%`;
		}
		
		// Update progress text
		const progressText = document.querySelectorAll('.engineering-progress-stat-value');
		if (progressText.length >= 2) {
			progressText[0].textContent = solvedCount.toString();
			progressText[1].textContent = `${progressPercent}%`;
		}
		
		// Update completion stat
		const completeStatValue = document.querySelector('.engineering-stat-card:last-child .engineering-stat-card-value');
		if (completeStatValue) {
			completeStatValue.textContent = `${progressPercent}%`;
		}
	}

	// Initialize on page load
	document.addEventListener('DOMContentLoaded', () => {
		const solvedProblems = loadSolvedProblems();
		
		if (solvedProblems.length === 0) {
			console.log('No solved problems data found');
			return;
		}
		
		// Update each problem row
		const problemRows = document.querySelectorAll('[data-problem-id]');
		let solvedCount = 0;
		
		problemRows.forEach((row) => {
			const problemId = row.getAttribute('data-problem-id');
			if (problemId && solvedProblems.includes(problemId)) {
				updateProblemStatus(problemId, row as HTMLElement);
				solvedCount++;
			}
		});
		
		// Update progress indicators
		updateProgressBar(solvedCount, problemRows.length);
		
		console.log(`Updated ${solvedCount}/${problemRows.length} problems as solved`);
	});
</script>
